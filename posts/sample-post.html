<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PureCore.ro | FunctionalProgramming.ro - Some Scala -related blog post</title>
  <meta name="description"
  content="Some Scala -related blog post (at) Ogg's Blog - Valentin Padurean on programming - ">
  <meta name="author" content="Ogg (Valentin Padurean)">
  <meta name="keywords"
  content="Ogg, Valentin, Padurean, programming, coding, functional, Scala">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/prism.css">
  <link rel="stylesheet" href="/css/hack.css">
  <link rel="stylesheet" href="/css/dark-grey.css">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="/css/site-dark.css">
  <script src="/js/webfont.js" type="text/javascript" async=""></script>
</head>
<body class="hack dark-grey" cz-shortcut-listen="true">
  <div class="main container">
    <header>
      <a href="/" class="header-logo-link"><img src="/img/purecore.ro.svg"></a>
      <h1>
        Ogg's Blog |
        <a href="/about.html">About</a>
      </h1>
      <p class="site-motto">
        <a href="http://purecore.ro">PureCore.ro</a> <span class="double-slash">//</span>
        <a href="http://functionalprogramming.ro" class="wip-random-joke">FunctionalProgramming.ro</a>
      </p>
    </header>
    <article class="page-content">
      <h1>
        Some Scala -related blog post
        <br/><small>@ <time pubdate datetime="2009-08-13">2016-08-13</time></small>
      </h1>
      <section>
        <h2>Food for thought</h2>
        <p>
          Very simply put, the idea behind backpressure is the ability to say "hey slow down!".
          Let's start with an example that has nothing to do with software:
          Imagine you own a factory that produces doughnuts (lucky you!) and just signed a contract
          with the largest grocery chain in the Northeast US.
          To increase output, you decided to overhaul your existing factory and open a new one.
          Late Monday evening you get a text "Emergency! Get to the factory now!".
          It turns out doughnuts were being produced 5% faster than they could be glazed and packaged.
          Needless to say, there was a big, tasty mess to clean up, one of the factories had to be
          temporarily shut down, and you couldn't fulfill your contract.
          <br/><br/>
          Misconfiguration can literally wreak havoc. To make matters worse, the glazer couldn't react
          by signalling "hey you, slow down!". Even if it could, it didn't have a way to hold on to
          some extra doughnuts or throw them into a plain donut bin while things slowed down.
          Being able to signal backpressure and handle temporary bursts is critical in building resilient systems.
          <br/><br/>
          Today we'll demonstrate backpressure in Akka Streams (note this is not an <a href="http://doc.akka.io/docs/akka/2.4/scala/stream/stream-introduction.html" target="_blank" class="opens_in_new">intro to Akka Streams</a> itself).
        </p>
      </section>
      <section>
        <h2>Basic Layout</h2>
        <p>
          Our examples will follow the structure shown below:
          <img src="http://2ivc9q2m0zajpk0cz1zc598z.wpengine.netdna-cdn.com/wp-content/uploads/blog/2016/08/akkastreamstopology.png"/>
          We'll produce a single sequence of integers (source), transform it by computing the factorial of each integer,
          print them to standard output (flow), and also write out the sequence to two files (broadcast to sinks).
          The following code does exactly that (please check out this
          <a href="https://github.com/skapadia/akka-streams-backpressure">Github repo</a>
          and use <code>sbt run</code> or fire up your favorite IDE):
        </p>

        <pre class="language-haskell"><code>
data DList a = DLNode (DList a) a (DList a)

mkDList :: [a] -> DList a

mkDList [] = error "must have at least one element"
mkDList xs = let (first,last) = go last xs first
            in  first

  where go :: DList a -> [a] -> DList a -> (DList a, DList a)
        go prev []     next = (next,prev)
        go prev (x:xs) next = let this        = DLNode prev x rest
                                  (rest,last) = go this xs next
                              in  (this,last)

takeF :: Integer -> DList a -> [a]
takeF 0     _                 = []
takeF (n+1) (DLNode _ x next) = x : (takeF n next)

takeR :: Show a => Integer -> DList a -> [a]
takeR 0     _                 = []
takeR (n+1) (DLNode prev x _) = x : (takeR n prev)
        </code></pre>

        <pre class="language-javascript"><code>
function showLangIconsAboveSnippets() {
  var langLabels =
  $('div.prism-show-language > div.prism-show-language-label');
  for (var i=0; i&lt;langLabels.length; i++) {
    var langLabel = $(langLabels[i]);
    var lang = langLabel.text().toLowerCase();
    if (lang === 'haskell') {
      langLabel.css('background-image', 'url("../img/haskell-logo.svg")');
      setCssForLangLabelWithImage(langLabel);
    } else if (lang === 'scala') {
      langLabel.css('background-image', 'url("../img/scala-logo.svg")');
      setCssForLangLabelWithImage(langLabel);
    } else if (lang === 'javascript') {
      langLabel.css('background-image', 'url("../img/javascript-logo.svg")');
      setCssForLangLabelWithImage(langLabel);
    }
  }
}
        </code></pre>

        <pre class="language-html"><code>
          &lt;span&gt;Some text&lt;span&gt;
        </code></pre>

        <pre class="language-scala"><code>
object StreamApp  {

  def lineSink(filename: String): Sink[String, Future[IOResult]] = {
    Flow[String]
    .alsoTo(Sink.foreach(s => println(s"$filename: $s")))
    .map(s => ByteString(s + "\n"))
    .toMat(FileIO.toFile(new File(filename)))(Keep.right)
  }

  def main(args: Array[String]): Unit = {

    implicit val system = ActorSystem("streamapp")
    implicit val materializer = ActorMaterializer()

    val source: Source[Int, NotUsed] = Source(1 to 100)
    val factorials: Source[BigInt, NotUsed] =
    source.scan(BigInt(1))((acc, next) => acc * next)
    val sink1 = lineSink("factorial1.txt")
    val sink2 = lineSink("factorial2.txt")
    val slowSink2 = Flow[String].via(Flow[String]
    .throttle(1, 1.second, 1, ThrottleMode.shaping))
    .toMat(sink2)(Keep.right)
    val bufferedSink2 = Flow[String].buffer(50, OverflowStrategy.dropNew)
    .via(Flow[String]
    .throttle(1, 1.second, 1, ThrottleMode.shaping))
    .toMat(sink2)(Keep.right)

    val g = RunnableGraph.fromGraph(GraphDSL.create() { implicit b =>
      import GraphDSL.Implicits._

      val bcast = b.add(Broadcast[String](2))
      factorials.map(_.toString) ~> bcast.in
      bcast.out(0) ~> sink1
      bcast.out(1) ~> sink2
      ClosedShape
    })

    g.run()
  }
}
        </code></pre>

      </section>


      <br/><br/>
      <section class="comments-section">

        <h2>Add a Comment</h2>
        <form method="POST" action="https://api.staticman.net/v2/entry/padurean/padurean.github.io/master/comments">
          <input name="options[redirect]" type="hidden" value="http://purecore.ro/posts/sample-post.html#comment-added">
          <input id="options-slug" name="options[slug]" type="hidden" value="sample-post">
          <input id="commenter-name" name="fields[name]" type="text" placeholder="Your Name" required oninput="this.setCustomValidity('')" oninvalid="this.setCustomValidity('Name is required')"><br/>
          <textarea id="commenter-message" name="fields[message]" placeholder="Your Comment (some GFM works, @mentions too)" required oninput="this.setCustomValidity('')" oninvalid="this.setCustomValidity('Comment is required')"></textarea><br/>
          
          <a name="comment-added" id="comment-added"></a>
          <button type="submit" class="btn btn-default btn-ghost">
            <i class="fa fa-comment medium left" aria-hidden="true"></i>
            <span class="btn-label">Add your comment</span>
          </button>
          <div id="comment-added-message" class="comment-added-message invisible">
            <i class="fa fa-info-circle medium left" aria-hidden="true"></i>
            Thanks. Your comment has been submitted for moderation.
          </div>
        </form>

        <h2>
          <i class="fa fa-comments-o large left" aria-hidden="true"></i>
          Comments
          <i class="fa fa-refresh medium left refresh-comments" aria-hidden="true"></i>
        </h2>
        <ul id="comments-wrapper" class="comments-wrapper">
          <li><i class="grey-text">Loading comments ...</i></li>
        </ul>

      </section>


    </article>

    <br/><br/><br/>

    <footer>
      <b style="font-family: sans-serif;">&copy;</b> Ogg
      <small>(Valentin Padurean)</small>
    </footer>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.34.2/es6-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.34.2/es6-sham.min.js"></script>
    <script src="https://wzrd.in/standalone/es7-shim@latest"></script> -->

    <script src="/js/jquery-3.1.0.min.js"></script>
    <script src="/js/prism.js"></script>
    <script src="/js/js-yaml.min.js"></script>
    <script src="/js/showdown-1.7.1.min.js"></script>
    <script src="/js/post.js"></script>
    <script src="/js/app.js"></script>
  </div>

</body>
</html>
