<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="Write SQL database migrations in Go with strong typing, zero non-stdlib dependencies, and build your own migration CLI with minimal boilerplate. database/sql and sqlx supported out of the box."><meta name="keywords" content="Go, CLI, database, SQL, migrations"><meta name="author" content="Valentin Padurean (Ogg)"><meta property="article:author" content="Valentin Padurean (Ogg)"><meta property="fb:app_id" content="355817918550120"><title>GoSMig: a tiny, type-safe way to build your own SQL database migration CLI in Go</title><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@vpadure"><meta property="og:type" content="article"><link rel="canonical" href="https://purecore.ro/posts/2025-10-23-gosmig-sql-database-migrations-written-in-go/"><meta property="og:url" content="https://purecore.ro/posts/2025-10-23-gosmig-sql-database-migrations-written-in-go/"><meta property="og:title" content="GoSMig: a tiny, type-safe way to build your own SQL database migration CLI in Go"><meta name="twitter:title" content="GoSMig: a tiny, type-safe way to build your own SQL database migration CLI in Go"><meta property="og:description" content="Write SQL database migrations in Go with strong typing, zero non-stdlib dependencies, and build your own migration CLI with minimal boilerplate. database/sql and sqlx supported out of the box."><meta name="twitter:description" content="Write SQL database migrations in Go with strong typing, zero non-stdlib dependencies, and build your own migration CLI with minimal boilerplate. database/sql and sqlx supported out of the box."><meta property="og:image" content="https://purecore.ro/images/logo/purecore-logotype.png"><meta property="og:image:secure_url" content="https://purecore.ro/images/logo/purecore-logotype.png"><meta name="twitter:image" content="https://purecore.ro/images/logo/purecore-logotype.png"><meta property="article:tag" content="Go"><meta property="article:tag" content="CLI"><meta property="article:tag" content="database"><meta property="article:tag" content="SQL"><meta property="article:tag" content="migrations"><link rel="shortcut icon" href="../../favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="../../images/icon-180.png"><meta name="msapplication-square70x70logo" content="../../images/icon-70-no-bg.png"><meta name="msapplication-square150x150logo" content="../../images/icon-150-no-bg.png"><meta name="msapplication-square310x310logo" content="../../images/icon-310-no-bg.png"><meta name="msapplication-wide310x150logo" content="../../images/icon-310x150-no-bg.png"><meta name="msapplication-TileColor" content="#ffffff"><link rel="alternate" type="application/rss+xml" title="PureCore.ro" href="https://purecore.ro/feed/rss.xml"><link rel="stylesheet" href="../../bundle-post.min.css?4"></head><body><header><div class="scroll-progress-container"><div class="scroll-progress-bar" id="scroll-progress-bar"></div></div><a href="../../" class="btn-go-home"><div class="purecore-logo">&nbsp;</div></a><div class="hamburger hamburger--spring-r"><div class="hamburger-box"><div class="hamburger-inner"></div></div></div><div id="nav-main" class="nav-main" style="display: none;"><ul><li><a href="../../" class="home-page-link">Home</a></li><li><a href="../../about/" class="about-page-link">About</a></li><li class="social-icon-links-in-menu"><a href="https://github.com/padurean" title="GitHub"><img class="github-icon-link" alt="GitHub" src="../../images/github-square-white.svg"></a><a href="https://twitter.com/OggPadurean" title="Twitter"><img class="twitter-icon-link" alt="Twitter" src="../../images/twitter-square-white.svg"></a><a href="https://www.linkedin.com/in/vpadure/" title="LinkedIn"><img class="linkedin-icon-link" alt="LinkedIn" src="../../images/linkedin-white.svg"></a><a href="https://www.facebook.com/vpadurean" title="Facebook"><img class="facebook-icon-link" alt="Facebook" src="../../images/facebook-square-white.svg"></a></li></ul></div></header><article class="full-post"><header class="post-header"><img class="post-thumbnail hidden" src=""><h1 id="post-title" class="post-title">GoSMig: a tiny, type-safe way to build your own SQL database migration CLI in Go</h1><div class="post-date-wrapper invisible"><span class="post-date-icon-wrapper">&nbsp;</span> <time id="post-date" class="post-date" datetime="2025-10-23T23:07:19+03:00">2025-10-23T23:07:19+03:00</time> <span class="post-ago">&nbsp;</span></div><img class="post-cover" src="https://raw.githubusercontent.com/padurean/gosmig/e52c9cc1e4a04ee418aef7936966c06e621ee265/graphics/gosmig-banner.png"></header><section id="post-body" class="post-body"><hr><p>If you’ve ever wanted a migration tool that feels like Go — small, explicit, type-safe, and database-agnostic — <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> hits a sweet spot. It doesn’t ship a full-featured binary. Instead, it gives you a minimal, well-typed core you can embed to build your own migration CLI with almost no boilerplate.</p><ul><li>Zero non-stdlib deps (only <a href="https://pkg.go.dev/golang.org/x/term">golang.org/x/term</a> for pager support in status)</li><li>Works with <a href="https://pkg.go.dev/database/sql">database/sql</a> or <a href="https://github.com/jmoiron/sqlx">sqlx</a> (and anything that implements a tiny interface)</li><li>Transactional and non-transactional migrations</li><li>Built-in commands: <strong><code>up</code></strong>, <strong><code>up-one</code></strong>, <strong><code>down</code></strong>, <strong><code>status</code></strong>, <strong><code>version</code></strong></li><li>Strong validation, timeouts, and clean error messages</li><li><a href="https://www.postgresql.org">PostgreSQL</a> integration tests and 100% test coverage</li></ul><p>Repo: <a href="https://github.com/padurean/gosmig">https://github.com/padurean/gosmig</a></p><p>Note: <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> is a library, not a binary. You write a 30–60 line <code>main()</code> to define migrations and wire in your DB connection, and <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> handles the CLI parsing and command behavior for you.</p><h2>Why another migrations tool?</h2><p>I wanted something that:</p><ul><li>Keeps migrations in Go, with first-class generics for strong typing.</li><li>Doesn’t force a file layout, code-gen step, or a vendor-specific driver.</li><li>Lets me choose transactional or non-transactional migrations per step.</li><li>Gives me a small, composable core I can embed in any service.</li></ul><p><a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> is basically “bring your own CLI wrapper,” with a dead-simple API that stays out of your way.</p><h2>TL;DR install</h2><pre><code class="language-console">go get github.com/padurean/gosmig
</code></pre><p>Go 1.25+ recommended.</p><h2>A 60-second example (<a href="https://pkg.go.dev/database/sql">database/sql</a>)</h2><p>Create a tiny <code>main.go</code> that defines migrations and a DB connector. You’ll end up with a custom binary like <code>./migrate</code>.</p><pre><code class="language-go">package main

import (
  "context"
  "database/sql"
  "fmt"
  "log"
  "time"

  _ "github.com/jackc/pgx/v5/stdlib"
  "github.com/padurean/gosmig"
)

func main() {
  // Define migrations (mix transactional and non-transactional as needed)
  migs := []gosmig.MigrationSQL{
    {
      Version: 1,
      UpDown: &amp;gosmig.UpDownSQL{ // runs inside a transaction
        Up: func(ctx context.Context, tx *sql.Tx) error {
          _, err := tx.ExecContext(ctx, `
            CREATE TABLE teams (
             id SERIAL PRIMARY KEY,
             name TEXT NOT NULL UNIQUE,
             created_at TIMESTAMPTZ DEFAULT NOW()
            )`)
          return err
        },
        Down: func(ctx context.Context, tx *sql.Tx) error {
          _, err := tx.ExecContext(ctx, `DROP TABLE teams`)
          return err
        },
      },
    },
    {
      Version: 2,
      UpDownNoTX: &amp;gosmig.UpDownNoTXSQL{ // runs without a transaction
        Up: func(ctx context.Context, db *sql.DB) error {
          _, err := db.ExecContext(ctx, `
            CREATE INDEX CONCURRENTLY idx_teams_created_at ON teams (created_at)`)
          return err
        },
        Down: func(ctx context.Context, db *sql.DB) error {
          _, err := db.ExecContext(ctx, `
            DROP INDEX CONCURRENTLY IF EXISTS idx_teams_created_at`)
          return err
        },
      },
    },
  }

  // Build a runner that parses args and executes commands
  run, err := gosmig.New(migs, connect, &amp;gosmig.Config{Timeout: 30 * time.Second})
  if err != nil {
    log.Fatalf("failed to build migrator: %v", err)
  }
  run() // handles: &lt;db_url&gt; &lt;up|up-one|down|status|version&gt;
}

func connect(url string, timeout time.Duration) (*sql.DB, error) {
  db, err := sql.Open("pgx", url)
  if err != nil {
    return nil, fmt.Errorf("open DB: %w", err)
  }
  ctx, cancel := context.WithTimeout(context.Background(), timeout)
  defer cancel()
  if err := db.PingContext(ctx); err != nil {
    return nil, fmt.Errorf("ping DB: %w", err)
  }
  return db, nil
}
</code></pre><p>Run it:</p><pre><code class="language-console">go run . postgres://user:pass@localhost:5432/dbname?sslmode=disable up
</code></pre><h2>Using <a href="https://github.com/jmoiron/sqlx">sqlx</a> (optional)</h2><p>Prefer <a href="https://github.com/jmoiron/sqlx">sqlx</a>? Swap the DB type and define aliases to keep signatures tidy:</p><pre><code class="language-go">package main

import (
  "context"
  "database/sql"
  "log"
  "time"

  _ "github.com/jackc/pgx/v5/stdlib"
  "github.com/jmoiron/sqlx"
  "github.com/padurean/gosmig"
)

type (
  MigrationSQLX  = gosmig.Migration[*sql.Row, sql.Result, *sql.Tx, *sql.TxOptions, *sqlx.DB]
  UpDownNoTXSQLX = gosmig.UpDown[*sql.Row, sql.Result, *sqlx.DB]
)

func main() {
  migs := []MigrationSQLX{
    {
      Version: 1,
      UpDown: &amp;gosmig.UpDownSQL{ /* ...same as stdlib example... */ },
    },
    {
      Version: 2,
      UpDownNoTX: &amp;UpDownNoTXSQLX{
        Up:   func(ctx context.Context, db *sqlx.DB) error { /* ... */ return nil },
        Down: func(ctx context.Context, db *sqlx.DB) error { /* ... */ return nil },
      },
    },
  }

  run, err := gosmig.New(migs, connectSQLX, nil)
  if err != nil {
    log.Fatal(err)
  }
  run()
}

func connectSQLX(url string, timeout time.Duration) (*sqlx.DB, error) {
  db, err := sqlx.Open("pgx", url)
  if err != nil {
    return nil, err
  }
  ctx, cancel := context.WithTimeout(context.Background(), timeout)
  defer cancel()
  return db, db.PingContext(ctx)
}
</code></pre><p>Tip: The provided <code>gosmig.UpDownSQL</code> works for both <a href="https://pkg.go.dev/database/sql">database/sql</a> and <a href="https://github.com/jmoiron/sqlx">sqlx</a> because it operates on <code>*sql.Tx</code>.</p><h2>CLI commands you get “for free”</h2><p>Once you wire up <code>main()</code>, <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> handles argument parsing and runs the command:</p><ul><li><strong><code>up</code></strong> — apply all pending migrations</li><li><strong><code>up-one</code></strong> — apply only the next migration</li><li><strong><code>down</code></strong> — roll back the most recent applied migration</li><li><strong><code>status</code></strong> — show all versions and whether they’re applied or pending (uses a pager when writing to stdout)</li><li><strong><code>version</code></strong> — print the current database version</li></ul><p>Examples:</p><ul><li><p>Apply all pending migrations:</p><p><code>./migrate &lt;db_url&gt;</code> <strong><code>up</code></strong></p><pre><code class="language-console">[x] Applied migration version 1
[x] Applied migration version 2
2 migration(s) applied
</code></pre></li><li><p>Apply only the next migration:</p><p><code>./migrate &lt;db_url&gt;</code> <strong><code>up-one</code></strong></p><pre><code class="language-console">[x] Applied migration version 3
1 migration(s) applied
</code></pre></li><li><p>Roll back the latest migration:</p><p><code>./migrate &lt;db_url&gt;</code> <strong><code>down</code></strong></p><pre><code class="language-bash">[x]--&gt;[ ] Rolled back migration version 3
</code></pre></li><li><p>Show status of all migrations:</p><p><code>./migrate &lt;db_url&gt;</code> <strong><code>status</code></strong></p><pre><code class="language-console">VERSION     STATUS
3           [ ] PENDING
2           [x] APPLIED
1           [x] APPLIED
</code></pre></li><li><p>Show current DB version:</p><p><code>./migrate &lt;db_url&gt;</code> <strong><code>version</code></strong></p><pre><code class="language-console">Current database version:
2
</code></pre></li></ul><h2>Internals in a nutshell</h2><p><a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> uses tiny, generic interfaces so anything that looks like <a href="https://pkg.go.dev/database/sql">database/sql</a> can plug in:</p><ul><li><code>DBRow</code>, <code>DBResult</code> mirror stdlib shapes</li><li><code>DB</code> and <code>TX</code> allow <code>QueryRowContext</code>/<code>ExecContext</code>/<code>BeginTx</code>/<code>Commit</code>/<code>Rollback</code></li><li>Generics tie it together without reflection or magic</li></ul><p>There are two migration styles:</p><ul><li>Transactional (<code>UpDown</code> with <code>*sql.Tx</code>) — best default; runs inside a transaction</li><li>Non-transactional (<code>UpDownNoTX</code> with <code>*sql.DB</code> or your DB type) — for things like <a href="https://www.postgresql.org">PostgreSQL</a>’s <code>CREATE INDEX CONCURRENTLY</code></li></ul><p>Migrations are validated at startup (unique, positive versions; both <code>Up</code> and <code>Down</code> present). A lightweight <code>gosmig</code> table tracks applied versions:</p><pre><code class="language-sql">CREATE TABLE gosmig (
  version INTEGER PRIMARY KEY,
  applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
</code></pre><p>Operations use a timeout (default <code>10s</code>; configurable via <code>&amp;gosmig.Config{Timeout: ...}</code>), and <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a> defends against concurrent version jumps during a migration with clear error messages.</p><h2>Concurrency: keep it single-writer</h2><p>Like any migration system, don’t run multiple writers at once. Use your DB’s advisory lock (or equivalent):</p><ul><li><a href="https://www.postgresql.org">PostgreSQL</a>: <code>pg_try_advisory_lock</code> / <code>pg_advisory_unlock</code></li><li><a href="https://www.mysql.com">MySQL</a>/<a href="https://mariadb.org">MariaDB</a>: <code>GET_LOCK</code> / <code>RELEASE_LOCK</code></li><li><a href="https://www.microsoft.com/en-us/sql-server">SQL Server</a>: <code>sp_getapplock</code> / <code>sp_releaseapplock</code></li><li><a href="https://www.sqlite.org">SQLite</a>: file lock or a serialized <code>BEGIN EXCLUSIVE</code> strategy</li></ul><p>There’s a <a href="https://www.postgresql.org">PostgreSQL</a> example linked from the repo’s examples branch.</p><h2>Tested: CI, coverage, and Docker</h2><ul><li><a href="https://www.postgresql.org">PostgreSQL</a> integration tests</li><li>100% coverage</li><li>Makefile for local workflows</li></ul><p>Some handy commands:</p><pre><code class="language-console"># run tests locally
make test

# spin up Dockerized Postgres and run tests
make test-docker

# lint and vulnerability checks
make lint
make vulncheck

# build (with checks) or build only
make build
make build-only
</code></pre><h2>When to use <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a></h2><p>Use it if you:</p><ul><li>Want your migrations in Go with strong typing and editor support</li><li>Prefer embedding a simple migration runner into your service/binary</li><li>Need explicit control over transactions vs. no-TX operations</li><li>Like small tools you can reason about quickly</li></ul><p>If you want a standalone, batteries-included CLI, you can still build one easily with GoSMig—but you’ll own the wrapper (which is usually a small and healthy amount of code).</p><h2>Links</h2><ul><li>Repo: <a href="https://github.com/padurean/gosmig">https://github.com/padurean/gosmig</a></li><li>Examples: <a href="https://github.com/padurean/gosmig/tree/examples">https://github.com/padurean/gosmig/tree/examples</a></li></ul><p>If you try <a href="https://github.com/padurean/gosmig"><strong>GoSMig</strong></a>, I’d love your feedback — PRs and issues are welcome.</p></section></article><section id="tags-section" class="tags-section"><div id="share-btns-container" class="share-btns-container"><a id="btn-share-twitter" href="https://twitter.com/share?url=https://purecore.ro/posts/2025-10-23-gosmig-sql-database-migrations-written-in-go/&amp;text=%0AGoSMig%3A%20a%20tiny%2C%20type-safe%20way%20to%20build%20your%20own%20SQL%20database%20migration%20CLI%20in%20Go%0A&amp;hashtags=Go%2CCLI%2Cdatabase%2CSQL%2Cmigrations" target="_blank" title="Share on Twitter"><img src="../../images/share-twitter.svg" alt="Twitter"> </a><a id="btn-share-facebook" href="https://www.facebook.com/sharer.php?u=https://purecore.ro/posts/2025-10-23-gosmig-sql-database-migrations-written-in-go/" target="_blank" title="Share on Facebook"><img src="../../images/share-facebook.svg" alt="Facebook"> </a><a id="btn-share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://purecore.ro/posts/2025-10-23-gosmig-sql-database-migrations-written-in-go/" target="_blank" title="Share on LinkedIn"><img src="../../images/share-linkedin.svg" alt="LinkedIn"> </a><a id="btn-share-copy-link" href="" target="_blank" title="Copy link to clipboard"><img src="../../images/share-link.svg" alt="Copy Link"> </a><span id="copy-link-tooltip" class="copy-link-tooltip" style="display: none;">copied</span></div><div id="tags-container" class="tags-container on-full-post"><a href="../../tags/?tags=Go"><span class="grey-text">#</span>Go</a> <a href="../../tags/?tags=CLI"><span class="grey-text">#</span>CLI</a> <a href="../../tags/?tags=database"><span class="grey-text">#</span>database</a> <a href="../../tags/?tags=SQL"><span class="grey-text">#</span>SQL</a> <a href="../../tags/?tags=migrations"><span class="grey-text">#</span>migrations</a></div><div class="clear-floats">&nbsp;</div></section><section id="page-nav" class="page-nav invisible"><a id="btn-older-post" class="btn with-icon left disabled" href="#"><span class="arrow-icon">&nbsp;</span> Older</a> <a id="btn-newer-post" class="btn with-icon right disabled" href="#">Newer <span class="arrow-icon">&nbsp;</span></a></section><section id="giscus-comments-section" class="giscus-comments-section"><div class="giscus"></div><script src="https://giscus.app/client.js" data-repo="padurean/padurean.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMDAxMzM4Mw==" data-category="Announcements" data-category-id="DIC_kwDOATFhR84Cv9Q8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async=""></script></section><section id="related-and-newer-posts" class="related-and-newer-posts"><input type="hidden" name="tags" id="tags-input" value="Go,CLI,database,SQL,migrations"> <input type="hidden" name="post-id" id="post-id-input" value="2025-10-23-gosmig-sql-database-migrations-written-in-go"><section id="other-post-summary-template-section" class="other-post-summary-template-section"><article class="post-summary"><a href="" class="post-link"><img class="post-thumbnail" src=""></a><a href="" class="post-link"><h1 class="post-title"></h1></a><div class="post-date-wrapper invisible"><span class="post-date-icon-wrapper">&nbsp;</span> <time class="post-date" datetime=""></time> <span class="post-ago"></span></div><a href="" class="post-link"><img class="post-cover" src=""></a><p class="post-description"></p><a class="post-read-more" href="#">▸ read more</a><div class="post-tags tags-container"></div><div class="clear-floats">&nbsp;</div></article></section><section id="related-posts" class="related-posts" style="display: none;"><header><span class="grey-text">▼</span> Related</header></section><section id="newest-posts" class="newest-posts" style="display: none;"><header><span class="grey-text">▼</span> Latest</header></section></section><div class="clear-floats">&nbsp;</div><footer><a href="../../" class="purecore-logo btn-go-home">&nbsp;</a> <span id="year-placeholder">2100</span> &nbsp;&nbsp; <a rel="alternate" type="application/rss+xml" href="https://purecore.ro/feed/rss.xml" class="subscribe-via-rss" title="Subscribe via RSS"><img src="../../images/rss.svg" alt="Subscribe via RSS"></a><div class="social-icon-links"><a href="https://github.com/padurean" title="GitHub"><img class="github-icon-link" alt="GitHub" src="../../images/github-square.svg"></a><a href="https://twitter.com/OggPadurean" title="Twitter"><img class="twitter-icon-link" alt="Twitter" src="../../images/twitter-square.svg"></a><a href="https://www.linkedin.com/in/vpadure/" title="LinkedIn"><img class="linkedin-icon-link" alt="LinkedIn" src="../../images/linkedin.svg"></a><a href="https://www.facebook.com/vpadurean" title="Facebook"><img class="facebook-icon-link" alt="Facebook" src="../../images/facebook-square.svg"></a></div><div class="clear-floats">&nbsp;</div><div class="made-with">made with <a href="https://github.com/padurean/markedista/"><span class="markedista-logotype">λλ</span><span class="markedista-logotext">arkedista</span></a></div></footer><script type="text/javascript" src="../../bundle-post.min.js?1"></script></body></html>